#!/usr/bin/env bash
# Activate local Node.js module bin (node_modules/.bin) for the current shell.
# Usage: source ./activate [start_dir]
#        . ./activate
# To undo: deactivate

# Ensure this file is sourced, not executed
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
	echo "Run: source ${BASH_SOURCE[0]}"
	exit 1
fi

# Prevent nesting
if [[ -n "${NODE_BIN_VENV_ACTIVE:-}" ]]; then
	echo "Already active at: ${NODE_WORKING_DIR:-}"
	return 0
fi


# Find nearest node_modules/.bin upwards from the given dir (or PWD)
_start_dir="${1:-$PWD}"
dir="$(_tmp="${_start_dir}"; cd "$_tmp" 2>/dev/null && pwd -P)"
prev=""

BIN_DIR=""
while :; do
	if [[ -d "$dir/node_modules/.bin" ]]; then
		BIN_DIR="$dir/node_modules/.bin"
		break
	fi
	prev="$dir"
	dir="$(cd "$dir/.." 2>/dev/null && pwd -P)"
	[[ "$dir" == "$prev" || -z "$dir" ]] && break
done

if [[ -z "$BIN_DIR" ]]; then
	echo "No node_modules/.bin found upward from: ${_start_dir}"
	echo "Run 'npm install' or 'pnpm install' first."
	return 1
fi

deactivate () {
    # reset old environment variables
    if [ -n "${_OLD_VIRTUAL_PATH:-}" ] ; then
        PATH="${_OLD_VIRTUAL_PATH:-}"
        export PATH
        unset _OLD_VIRTUAL_PATH
    fi

    # Call hash to forget past commands. Without forgetting
    # past commands the $PATH changes we made may not be respected
    hash -r 2> /dev/null

    if [ -n "${_OLD_VIRTUAL_PS1:-}" ] ; then
        PS1="${_OLD_VIRTUAL_PS1:-}"
        export PS1
        unset _OLD_VIRTUAL_PS1
    fi

    unset VIRTUAL_ENV
    unset VIRTUAL_ENV_PROMPT
	unset NODE_BIN_VENV_ACTIVE
	unset NODE_WORKING_DIR
	unset _start_dir
	unset dir
	unset prev
    if [ ! "${1:-}" = "nondestructive" ] ; then
    # Self destruct!
        unset -f deactivate
    fi
}
# unset irrelevant variables
deactivate nondestructive

# Working directory
NODE_WORKING_DIR="${1:-$PWD}"

VIRTUAL_ENV="$BIN_DIR"
export VIRTUAL_ENV

_OLD_VIRTUAL_PATH="$PATH"
PATH="$BIN_DIR:$PATH"
export PATH

if [ -z "${VIRTUAL_ENV_DISABLE_PROMPT:-}" ] ; then
	proj_name="$(basename "$(cd "$dir" && pwd -P)")"
	_OLD_VIRTUAL_PS1="${PS1:-}"


	PS1="(${proj_name}) ${PS1:-}"
	VIRTUAL_ENV_PROMPT="(${proj_name}) "

	export PS1
	export VIRTUAL_ENV_PROMPT
fi

hash -r 2> /dev/null
NODE_BIN_VENV_ACTIVE=1
export NODE_BIN_VENV_ACTIVE
